<?xml version="1.0" encoding="UTF-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="15.0" InitialTargets="_TouchApp">
	<PropertyGroup>
		<BuildDependsOn>
			$(BuildDependsOn);
			_BuildAppBundle
		</BuildDependsOn>
		<CleanDependsOn>
			_CleanAppBundle;
			$(CleanDependsOn);
		</CleanDependsOn>
	</PropertyGroup>

	<PropertyGroup>
		<IsMac Condition="'$(OS)' == 'Unix' and $([System.IO.File]::Exists('/usr/lib/libc.dylib'))">True</IsMac>
		<AppBundleName Condition="'$(AppBundleName)'==''">$(MSBuildProjectName)</AppBundleName>
		<InputAppPath Condition="'$(InputAppPath)'==''">$(MSBuildProjectDirectory)\Mac\</InputAppPath>
		<OutputAppPath Condition="'$(OutputAppPath)'==''">$(TargetDir)\$(AppBundleName).app</OutputAppPath>
		<OutputContents>$(OutputAppPath)\Contents</OutputContents>
		<OutputMonoBundlePath>$(OutputContents)\MonoBundle</OutputMonoBundlePath>
		<LauncherFile>$([System.IO.Path]::GetFileNameWithoutExtension('$(TargetFileName)'))</LauncherFile>
		<LauncherFileWithPath>$(OutputContents)\MacOS\$(LauncherFile)</LauncherFileWithPath>
	</PropertyGroup>

	<PropertyGroup Condition="$(RunConfiguration) == 'Mac' AND $(IsMac) == 'True' ">
		<StartAction>Program</StartAction>
    	<StartProgram>$(OutputAppPath)</StartProgram>
	    <ExternalConsole>false</ExternalConsole>
	</PropertyGroup>

	<Target Name="_TouchApp">
		<!-- This makes it so we can debug in VS for Mac right away without building first -->
		<MakeDir Directories="$(OutputAppPath)" Condition="'$(IsMac)' == 'True'" />
	</Target>

	<Target Name="_CleanAppBundle">
		<RemoveDir Directories="$(OutputAppPath)"/>
	</Target>
	<Target Name="_BuildAppBundle">
		<PropertyGroup>
			<MonoMacArch Condition="'$(MonoMacArch)'==''">x86_64</MonoMacArch>

			<ReferenceFiles>$(MSBuildThisFileDirectory)</ReferenceFiles>
			<PListFile>$(OutputContents)\Info.plist</PListFile>
			
			<LauncherExecutable Condition="'$(LauncherExecutable)' == '' AND $(MonoMacArch)=='x86_64'">$(ReferenceFiles)\Launcher64</LauncherExecutable>
			<LauncherExecutable Condition="'$(LauncherExecutable)' == '' AND $(MonoMacArch)=='i386'">$(ReferenceFiles)\Launcher32</LauncherExecutable>
		</PropertyGroup>

		<!-- Delete monobundle path, we're going to rebuild it -->
		<RemoveDir Directories="$(OutputMonoBundlePath)"/>

		<!-- Copy icon/launcher/etc -->
		<Copy SourceFiles="$(InputAppPath)\**\*.*" DestinationFolder="$(OutputContents)" SkipUnchangedFiles="true" Condition="Exists('$(InputAppPath)')" />
		<Copy SourceFiles="$(ReferenceFiles)\Launcher64" DestinationFiles="$(LauncherFileWithPath)" SkipUnchangedFiles="true" />
		<Copy SourceFiles="$(ReferenceFiles)\Info.plist" DestinationFiles="$(PListFile)" Condition="!Exists('$(OutputContents)\Info.plist')" />

		<!-- Copy ouput files, except for non-mac Eto platforms -->
		<ItemGroup>
			<ExecutableFiles Include="$(TargetDir)\**" Exclude="$(OutputAppPath)\**\*" />
			<ExecutableFiles Remove="$(TargetDir)\*.vshost.*" />
			<!--
			<ExecutableFiles Remove="$(TargetDir)\**\*.pdb" />
			<ExecutableFiles Remove="$(TargetDir)\**\*.mdb" />
			-->
			<ExecutableFiles Remove="$(TargetDir)\Eto.Gtk2.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.Gtk3.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.Wpf.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.WinForms.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.iOS.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.WinRT.*" />
			<ExecutableFiles Remove="$(TargetDir)\Eto.Android.*" />
		</ItemGroup>
		<Copy SourceFiles="@(ExecutableFiles)" DestinationFolder="$(OutputMonoBundlePath)\%(RecursiveDir)" />

		<!--
			Add any missing keys to the PListFile
		-->
		<_UpdatePList 
			PListFile="$(PListFile)"
			TargetFileName="$(TargetFileName)"
			AppBundleName="$(AppBundleName)"
			LauncherFile="$(LauncherFile)"
			/>
		<!-- Set executable bit on launcher if on *nix -->
		<Exec Command="chmod +x &quot;$(LauncherFileWithPath)&quot;" Condition="'$(OS)'=='Unix'" />
	</Target>
	<UsingTask TaskName="_UpdatePList" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
		<ParameterGroup>
			<PListFile ParameterType="System.String" Required="true" />
			<TargetFileName ParameterType="System.String" Required="true" />
			<AppBundleName ParameterType="System.String" Required="true" />
			<LauncherFile ParameterType="System.String" Required="true" />
		</ParameterGroup>
		<Task>
			<Reference Include="System.Xml" />
			<Using Namespace="System" />
			<Using Namespace="System.IO" />
			<Using Namespace="System.Xml" />
			<Code Type="Class" Language="cs"><![CDATA[
            using System;
			using System.IO;
			using System.Xml;
			using System.Text;
            using Microsoft.Build.Framework;
            using Microsoft.Build.Utilities;

            public class _UpdatePList : Task
            {  
				[Required]
                public string PListFile { get; set; }
				[Required]
                public string TargetFileName { get; set; }
				[Required]
                public string AppBundleName { get; set; }
				[Required]
                public string LauncherFile { get; set; }
                public bool HasIcon { get; set; }

                XmlDocument xml;
				XmlNode dict;

				class NullSubsetXmlTextWriter : XmlTextWriter
				{
					XmlWriterSettings _settings;
					public NullSubsetXmlTextWriter(string inputFileName, Encoding encoding)
						: base(inputFileName, encoding)
					{
						Formatting = Formatting.Indented;
						IndentChar = ' ';
						Indentation = 2;
						_settings = new XmlWriterSettings();
						_settings.Encoding = Encoding.UTF8;
						_settings.Indent = true;
						_settings.IndentChars = "  ";
						_settings.NewLineChars = "\n";
						_settings.NewLineHandling = NewLineHandling.Entitize;
					}

					public override XmlWriterSettings Settings { get { return _settings; } }

					public override void WriteDocType(string name, string pubid, string sysid, string subset)
					{
						// fix issue writing doctype
						if (subset == string.Empty)
							subset = null;
						base.WriteDocType(name, pubid, sysid, subset);
					}
				}

				void AddStringProperty(string name, string value, bool force = false)
				{
					XmlNode node;
				
					var exists = dict.SelectSingleNode("key[text()='" + name + "']") != null;
					if (exists && !force)
						return;
				
					dict.AppendChild(node = xml.CreateNode(XmlNodeType.Element, "key", null));
					node.InnerText = name;
					dict.AppendChild(node = xml.CreateNode(XmlNodeType.Element, "string", null));
					node.InnerText = value;
				}
				
                public override bool Execute()
                {
					xml = new XmlDocument();
					xml.Load(PListFile);

					dict = xml.SelectSingleNode("plist/dict") as XmlElement;

					AddStringProperty("CFBundleInfoDictionaryVersion", "6.0");
					AddStringProperty("CFBundlePackageType", "APPL");
					AddStringProperty("CFBundleSignature", "????");
					AddStringProperty("NSPrincipalClass", "NSApplication");
					AddStringProperty("CFBundleName", AppBundleName);
					AddStringProperty("CFBundleExecutable", LauncherFile, true);
					AddStringProperty("LSMinimumSystemVersion", "10.7");

					using (var sw = new NullSubsetXmlTextWriter(PListFile, Encoding.UTF8))
						xml.Save(sw);
                    return true;
                }
            }
        ]]></Code>
		</Task>
	</UsingTask>
</Project>